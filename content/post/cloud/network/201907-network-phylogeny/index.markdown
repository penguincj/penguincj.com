
云计算数据中心网络

云网络作为云计算的基础设施，包含物理网络和虚拟网络，具有如下的特点

- 跨越物理网络、虚拟网络的连通性，跨 Overlay、机房的连接，公有云、私有云和混合云的打通。
- 很强的隔离性，不同租户之间的流量强隔离，不能互相影响。
- 大规模组网，在同一个数据中心里可能有几万台的设备。当网络规模达到一定程度时，复杂度将大大增加。
- 高性能，网络中各个节点的带宽都在增加，需要充分利用带宽来实现最高性能，最终达到降低成本的目的。
- 可观测性，由于以上特点，云网络变得非常复杂，在出现问题时如何能快速排查网络故障是一个难题。网络需要提供更好的可观测性来支持问题的快速解决。

本文介绍当前数据中心网络的主流技术，可以说是满足云网落上述特点的最佳实践。

# 组网

## Clos 架构

云计算的流量模型不同于传统网络模型，因为更多的分布式应用导致东西向流量剧增，越来越多的数据中心采用 spine-leaf 的 Clos 架构，spine交换机和leaf交换机之间是以full-mesh方式连接。这样 spine-leaf 结构的网络更加方便水平扩展。

<img alt="index-eba8fd41.png" src="images/index-eba8fd41.png" width="" height="" >

在spine/leaf架构中，每一层的作用分别是：

- leaf switch：相当于传统三层架构中的接入交换机，作为TOR（Top Of Rack）直接连接物理服务器。与接入交换机的区别在于，L2/L3网络的分界点现在在leaf交换机上了。leaf交换机之上是三层网络。
- spine switch：相当于核心交换机。spine和leaf交换机之间通过ECMP（Equal Cost Multi Path）动态选择多条路径。区别在于，spine交换机现在只是为leaf交换机提供一个弹性的L3路由网络，数据中心的南北流量可以不用直接从spine交换机发出，一般来说，南北流量可以从与leaf交换机并行的交换机（edge switch）再接到WAN router出去。

## SONiC


由于 Clos 架构具有诸多的优点，是用多个小规模、低成本的单元构建复杂，大规模的架构。构建大型网络不再需要高端核心交换机，而是通过普通的盒式交换机就可以堆出大规模、高性能的高可用网络。而这种盒式交换机制造和研发难度不是特别大，所以大型的互联网公司（Facebook、亚马逊、微软、百度、阿里、美团等）纷纷做自研交换机，在降低成本的同时还能针对自己的应用场景做优化。

其中微软开源的 [SONiC]() 得到了最好的发展，很多用户和厂商积极参与 SONiC 社区。目前支持多款不同芯片不同厂家的硬件，具备二三层交换路由的基本功能。

用 SONiC 系统的白盒来搭建 Clos 系统非常合适，首先 SONiC 支持 BGP 和基本的转发功能，BGP 适合大规模组网需求，功能满足数据中心的使用要求。基于可定制的高性能 CPU 硬件平台，和基于 docker 的系统架构很容易扩展和开发，可以在交换机上做些网络监控的应用，比如丢包、时延、buffer监控等。


# 网络虚拟化

云计算本质就是虚拟化，正是由于计算和网络的虚拟化才促进了云计算的蓬勃发展。

## VxLAN

VxLAN （Virtual eXtensible Local Area Network，虚拟扩展局域网）正是解决网络虚拟化的技术，将网络虚拟成大二层，可以方便相同的租户远距离连通和不同的租户物理隔离，还能支持虚机的迁移，非常适用于云计算。

<img alt="index-92e65ca6.png" src="images/index-92e65ca6.png" width="" height="" >

图，VxLAN 网络模型

## 流量模型

### 相同子网互通

<img alt="index-74ee6359.png" src="images/index-74ee6359.png" width="" height="" >

相同子网的流量互通比较简单，不需要三层网关，部署方案如上图所示。Leaf1和Leaf2作为VXLAN网络的VTEP，两个Leaf之间搭建VXLAN隧道，并在每个Leaf上部署VXLAN二层网关，即可实现同一部门VM之间的相互通信。此时Spine只作为VXLAN报文的转发节点，不感知VXLAN隧道的存在，可以是任意的三层网络设备。

### 不同子网互通

不同子网的流量互通需要部署三层网关，根据网关的部署模式不同可以分为集中式网关和分布式网关。

#### 集中式网关

如下图所示，Leaf1、Leaf2和Spine作为VXLAN网络的VTEP，Leaf1和Spine之间、Leaf2和Spine之间分别搭建VXLAN隧道，并在Spine上部署VXLAN三层网关，即可实现不同部门VM之间的相互通信。

<img alt="index-a4d08d36.png" src="images/index-a4d08d36.png" width="" height="" >


**优点:**

- 结构比较简单，组网也相对容易
- 网关集中在核心上，方便管理

**缺点:**

- 转发路径不是最优
- 核心交换机ARP表项规格，规模有限
- 所有设备都在大二层，受到BUM的影响后，故障域比较大

#### 分布式网关

集中式网关具有如上的这些缺点，使用分布式网关可以很好的解决一些问题。

**同Leaf节点下VM之间的通信**

在 Leaf 上部署了三层 VxLAN 网关后，同一个 Leaf 下的跨子网访问，可以在 Leaf 上直接转发，不再需要经过Spine节点，从而节约了大量的带宽资源。

**跨Leaf节点VM之间的通信**

两个VXLAN三层网关之间通过BGP动态建立VXLAN隧道，并通过BGP的remote-nexthop属性发布本网关下挂的主机路由信息给其他BGP邻居，从而实现跨Leaf节点不同部门VM之间的相互通信。

<img alt="index-799f4068.png" src="images/index-799f4068.png" width="" height="" >

**优点:**

- 转发灵活，一个Leaf节点可以做L2接入，也可以做L3网关
- ARP表项分散到TOR上，减缓了核心的压力，支持规模大于集中式部署

**缺点:**

- 组网相对复杂

## OVS

说到虚拟网络不得不提到大名鼎鼎的 [OVS（Open vSwitch）](https://www.openvswitch.org/)，OVS 是由 Nicira Networks 公司用 C 语言开发的高质量、多层虚拟交换机，为连接虚拟主机构建复杂网络应用提供支持，支持多种数据面和管理面协议，如：VxLAN、sFlow、CLI、LACP 等。

OVS 支持 Openflow 协议，可以使用任何支持 Openflow 协议的控制器集成，比如可以与 OpenStack Neutron 的网络插件对接；在没有 Openflow 控制器的情况下 OVS 可以作为传统的二层交换机通过 MAC 学习来完成二层数据转发。Linux Bridge 也可以通过 MAC 地址学习实现二层转发，但是功能比较简单，而 OVS 支持更多的高级特性，比如 Openflow、QoS、ACL 及多种隧道封装，这也是 OVS 更加适用于 SDN 的原因。


主要包括以下模块和特性：

-


以其对 Openflow 的支持，可以灵活的实现多种网络协议和各种网络需求，而被广泛应用在云计算虚拟网络中，


### 问题

OVS 支持 ACL QoS ？




# 高性能网络

## DPDK



## RDMA



# IPv6




当前服务器 CPU 性能越来越强，网卡速率越来越高，当前主流数据中心的服务器网卡速率都是 25Gbps，部分业务达到了 100Gbps。ToR 的收敛比也越来越高，云计算数据中心多采用的组网方式是 Clos 架构，其思想。











DPDK

RDMA

智能网卡








从计算机诞生开始就有了网络，随着计算机和各种计算单元的不断演进，网络也在经历一些发展，网络之于计算机就像如同空气之于人一般重要。了解网络的发展史，才能更高的把握网络的未来。

# 计算机网络发展的七个阶段

1. 批处理

最开始的计算机的主要用于大规模运算和处理，需要先将用户程序和数据写入到存储设备，在计算时被读取，这是批处理系统。


2. 分时系统

在 20 世纪 60 年代出现了分时系统，可以多个用户同时访问一台计算机，这样每个终端和计算机之间的通信线路组成了最早的网络。

3. 计算机通信技术

到了 20世纪 70 年代，随着计算机的数量普及，计算机之间的数据交互的便捷性越来越受到重视，最开始两个主机之间交互数据过程相当繁琐，因此计算机通信技术（计算机与计算机之间由通信线路连接）应运而生。人们可以很轻松的即时读取另一台计算机中的数据，从而极大地缩短了传输数据的时间。

4. 计算机网络的产生

20世纪70年代，人们开始实验基于分组交换技术的计算机网络，并着手研究不同厂商的计算机之间相互通信的技术。到了80年代，一种能够互联多种计算机的网络应运而生。网络通信技术进入了发展的高速公路。

而计算机技术的发展和普及让人们对网络不再陌生。随着操作计算机难度不断下降，更是拉近了人们与网络之间的距离。

5. 互联网的普及

进入20世纪90年代，随着计算机的价格降低、性能增强、各类应用纷纷冒头，计算机普及程度越来越高。

于此同时，电子邮件、万维网等信息传播方式如雨后春笋般迎来了前所未有的发展，使得互联网从大到整个公司范围小道每个家庭内部，都得以广泛普及。

面对这一趋势，各家厂商不仅要保证生产产品的自身互联性，还着力于让自己的网络技术不断与 **互联网技术（TCP/IP）** 兼容。

6. 互联网时代

互联网的普及和发展对通信领域产生了翻天覆地的影响。曾经一直在通信领域具有霸主地位、支撑通信网络的电话网，也渐渐被IP网络所替代。后互联网时代的万物互联将登上舞台，为人类的生活带来翻天覆地的变化。

7. 网络安全

在互联网普及的初期，人们更关注单纯的连接性，注重不受任何限制的建立连接。但现在，人们不再满足与“单纯的连接”而是更为追求“安全的连接”。



# TCP/IP简史

1. 军用技术

早在20世纪60年代，美国军方就认识到新的通讯技术对国防有着举足轻重的作用。一开始，通信线路都是星型拓扑，这种拓扑对于天灾人祸的抵抗力极低，有着致命的问题，单点故障。为了实现一种可以多备份、多路径的冗余网络拓扑，以至于不会因为天灾人祸（如核弹攻击）导致通信网络中断。为了实现这种网络，分组交换技术便应运而生。

2. ARPANET（阿帕网）

为了验证分组交换技术的实用性，研究人员搭建了一个实验网络。随着美国国防部的科研力量的倾斜和相关技术的发展，规模不断扩大，普通用户也逐渐加入，后来发展成了巨大规模的网络。

该网络被称作ARPANET，也是全球互联网的鼻祖。短短三年，在国家力量和利益驱动下，ARPANET从曾经的4个节点迅速发展成为34个节点的超大规模网络。

3. TCP/IP的出世

ARPENET不仅仅是利用几所大学与研究机构组成的主干网络进行分组交换实验，还会进行在计算机之间互联提供可靠传输的综合性通信协议的实验。

在20世纪70年代前期，ARPENET的一个研究机构研发出了TCP/IP。虽然TCP/IP只是ARPENET的一个副产物，但是没有人会想到，TCP/IP在后来对世界网络产生的巨大影响！


4. UNIX系统的助攻

开始 TCP/IP 应用和影响的规模有限，直到 1980 年，划时代的 UNIX 系统出世，UNIX 实现了 TCP/IP 协议，随着 UNIX 的发展，基于 TCP/IP 构建的网络迅速盛行。在基于TCP/IP而形成的世界性范围的网络--互联网的影响下，那些”各自为政“开发自己通信协议的网络设备供应商也陆续遵循TCP/IP协议规范，以便制造兼容性更好的产品。

5. 互联网商业化

到了90年代，计算机快速普及，各种互联网技术的新型应用也涌现出来，人们通过互联网接入服务的具有商用许可的提供商（ISP）拨号连接进互联网，享受到互联网的各种服务。

6. TCP/IP 五层与 OSI 七层

20世纪90年代，ISO开展了OSI这一国际标准协议的标准化进程。然而，OSI协议并没有得到普及，真正被广泛应用的是TCP/IP协议。TCP/IP 凭借自己的 **开放性、和注重实用性**（即协议能否被广泛实际应用）两大特点，成为了主流协议簇。
